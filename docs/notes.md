# Interactive Brokers / IBPy / IBroke Notes

## User Notes

### Use the (Limited) Demo Without Signing Up
You can [download Trader Workstation](https://www.interactivebrokers.com/en/index.php?f=16040) (TWS) and use
the demo account (username `edemo`, password `demouser`) without signing up for anything.
Real-time market (tick) data is synthesized (read: completely fake).
All settings are lost each time the application exits/restarts, which it does once a day.
In particular you will need to manually re-enable API access each time you start TWS.
You are assigned a different account number each time you log in to the demo account.  Random
trades may happen on their own.  Historical data and real-time bars are not available (synthesized real-time ticks are).

### The API is Proxied
The IB API is unusual in that you do not connect directly to IB's servers; you connect to a
(usually) locally-running instance of the Trader Workstation application, which then proxies
your requests.  There is also a stripped-down API-only (non-GUI) dedicated proxy called the
IB Gateway.  While this seems like unnecessary complexity and delay, it has the benefit of
freeing API clients from worrying about authentication, which can be a non-trivial concern when
a lot of money is at stake.

### Real Market Data Costs Real $$$
Delayed data is not forwarded through the API: you cannot get real market data without paying.

| Account Type      | Market Data | API Access | Availability
| ------------      | ----------- | ---------- | ------------
| Demo              | Synthesized | Yes        | [23/6](https://www.interactivebrokers.com/en/index.php?f=2225)
| Paper unfunded    | Delayed     | No         | Market hours
| Paper funded      | Real-time   | Yes        | Market hours
| Real money funded | Real-time   | Yes        | Market hours

For real-time data, you must have a funded account AND pay for a market data subscription
(generally ~$10/mo, waved if you make enough trades).  Real-time data for forex and bonds is
free.  You can subscribe to 100 real-time market data feeds at a time (or pay for more).

### IB Shuts Down Every Night
IB servers shut down for maintenance every night from 11:45 PM - 12:45 AM Eastern, though they may be
available during some of this time.  Fridays they are totally down the entire time, but they start back up at 12:30 AM
instead of 12:45 AM. Orders on the books are still in force during this time.  They do not recommend
trading during this window.

### TWS Shuts Down Every Night
Independent from the IB servers going down every night, the TWS desktop application also shuts down once a day.
By default this happens at 11:45 PM, but the time can be configured in the settings.  The gateway does
not do this. Note that one reason TWS restarts daily is that active trading causes memory usage to grow without bound,
leading to a progressively slower and soon completely unresponsive application.  The gateway does not do this.
[IB Controller](https://github.com/ib-controller/ib-controller) can avoid the daily restart, automate logins,
dismiss dialogs, and much more.  Highly recommended.

### Forex
Forex (CASH instrument) quotes do not have volume, last trades, or last trade timestamps.
IB's IDEALPRO exchange is open Sun - Fri, with a trading halt 5:00 PM - 5:15 PM Eastern.
The minimum order size is at least 20,000 (higher for some currencies).

### Futures
There is no way to get open interest for futures through the API.


## Implementation Notes

First: the IB API is asynchronous and callback-based.
That means when you make a request there is no immediate response,
but some time later a message may arrive (and a callback will be called) with the response.
Some requests generate one or a few response messages; some subscribe to a continuous stream of
messages; and some messages arrive without any request, generated by the system.  This makes
error handling particularly challenging, because errors are disconnected from the erroneous
requests, and a successful request may be indicated by the absence of any message at all.

IBPy can only call one of your callbacks at a time, so you cannot wait for a callback in another
callback.

### Accounts
Positions and portfolio updates are shared between client IDs.

There is no official way to determine via the API if your account is a paper or live money account (a
potentially costly shortcoming).  The best you can do is check account numbers (your paper and live
accounts will be different).  It appears you can detect the demo account
via `reqAccountSummary()` with a tag of `AccountType` by checking for the value `UNIVERSAL` (but this
is not documented).

### Executions
To get commission and PNL info you have to listen for `commissionReport` messages, which are generated for
every execution, and point to executions (not orders) with crazy string IDs.  So to tally commissions and PNL
per-order, you need to track a map of executions (with crazy string IDs) to orders.
You might try to use `openOrder.orderState` messages, but there are dupes and the commissions are often giant
placeholder values (and some other dollar values are strings...), and they don't have PNL.

### Market Data
There is no way to say "give me N-second OHLC bars," you have to handle ticks and build bars yourself.
There is `reqRealTimeBars()`, which only give 5 second bars, but doesn't seem to work with the demo account.
At any rate if you want faster than 5-second resolution, you have to do it yourself.

Historical ticks are not available; the finest historical resolution is 1-sec OHLC bars.

The Volume tick type (tick id 8) only fires rarely, can change sporadically, and seems significantly behind.  Best ignored.
`RTVOLUME` (request generic tick id 233, tick type 48) ticks can be used instead, but not all instruments have them.
* Stocks:
    last and lastsize also rarely print and seem to be missing trades.
    Stocks have RTVOLUME.
* Forex:
    there are no times, lasts, or volumes; only bids and asks and their sizes.
    Forex does not have RTVOLUME.
* Futures:
    Volume ticks and the volume from RTVOLUME are radically different (maybe they restart at different times of day?).
    RTVOLUME usually fires before last/lastsize/lasttime.
    There are often duplicate lastsizes.
    `OPEN_INTEREST` ticks are not sent for futures.
    The bid usually changes before the ask, and the prices usually change before the sizes.
    The `position.avgCost` is the cost of the full underlying contract, not the bid/ask -- i.e., `avgCost` is the leverage multiplier times the bid/ask.


### Orders
You must assign monotonically increasing order ids to your orders.
They only have to be monotonic per client ID, but they do persist across disconnects.
`reqIds()` will send one `nextValidId` which will give you the next highest unused number.

The general idea is that different client IDs can only see and modify/cancel orders created with their own client ID.
There are two special IDs: 0, which receives but cannot modify orders and trades made in the TWS GUI; and the 'Master API Client ID',
which receives but cannot modify orders and trades made by all clients including TWS.
(The Master ID is disabled by default and can be set in the TWS configuration.)
TWS can view, modify, and cancel all orders.

`cancelOrder` can only cancel orders with the same client ID as the order was created with.
`cancelOrder` cannot cancel orders made in TWS.
`reqOpenOrders` will send you only orders made by the current client ID.
`reqAllOpenOrders` will send you all orders made by all client IDs and TWS, but you cannot modify/cancel other clients' orders.
`reqAutoOpenOrders` can only be used with client id 0, and does not send currently open orders, but sends any orders subsequently created in TWS to client id 0.
`reqGlobalCancel` will cancel all API and TWS orders, regardless of the creator or caller's client ID.
`reqGlobalCancel` will only send `openOrder` or `orderStatus` messages to the client ID that created the orders (or the master ID).

If there are open orders for your client ID and TWS is set to send them on connect (the default), `openOrder` and `orderStatus` messages
generally come very first thing.

### Time

[ContractDetails](https://interactivebrokers.github.io/tws-api/classIBApi_1_1ContractDetails.html#gsc.tab=0) objects, among others,
supply times as 24-hour times with a given timezone abbreviation.  The abbreviations _seem_ (?) to be the deprecated and ambiguous
[abbreviations used by Java](http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/sun/util/calendar/ZoneInfoFile.java/#219)
(TWS is written in Java and IB is a Java shop).  For example, instruments listed on the Chicago Mercantile Exchange have market hours with a timezone
of "CST" (Central Standard Time) during the Summer, when Chicago is actually observing CDT, Central Daylight Time.  It seems the correct
approach to getting a usable UTC offset is to map the abbreviations to "standard" timezone names following the Java source, then use the
the standard name with a timezone library.


### Disconnects
Error code 1100 means TWS has lost its connection to IB servers, and you cannot send commands (this happens e.g. with IB's daily maintenance).
However, market data is a separate connection and often continues even while TWS is "disconnected."  Thus you may be generating tick events
while unable to act on them.  Codes 1101 and 1102 mean you have reconnected, but 1101 means you have to re-subscribe to market data and
account updates.


### Documentation links
* https://www.interactivebrokers.com/en/software/api/api_Left.htm  - Reference, slightly more correct
* https://xavierib.github.io/twsapidocs/index.html - Reference, slightly more up to date
* http://files.meetup.com/1551526/Interactive_Brokers_API.pdf - (Java) implementation notes
* http://holowczak.com/ib-api-tutorials-by-programming-language/ - From-scratch hand-holding tutorials for multiple languages
* https://groups.io/g/twsapi - Most active IB forum / user group
* https://www.interactivebrokers.com/fluxbb/viewforum.php?id=2 - Official IB forum

## Development Roadmap
